- import_playbook: /home/jenkins/jenkans/egz-mf/ansible/project_vars.yml
- name: Run Images EGZ-MF
  hosts: web-egz
  become: yes
  vars:
    project_name: "{{ lookup('env','PROJECT_NAME') }}"
    dest_dir: /home/ansible/docker-projects/egz-mf/docker4run/
    app_host_dir: /home/ansible/docker-projects/egz-mf/app
    app_docker_dir: /usr/local/nginx/html
    nginx_dir: /usr/local/nginx/sbin
  
  tasks:
  - name: -----> Debug Pproject name
    debug: var=project_name
    
  - name: Stop Docker container
    shell: docker stop `docker ps | grep {{ project_name }} | cut -d' ' -f1`
    ignore_errors: true
    
  - name: Build Docker image
    shell: cd {{ dest_dir }} && docker build -f Dockerfile.yml -t {{ project_name }} .
  
  - name: Start Docker container
    shell: docker run --rm -d -p 8080:8080 -v {{ app_host_dir }}:{{ app_docker_dir }}:ro {{ project_name }} /bin/bash
    
  - name: Start NGINX сервер
    shell: docker exec -it `docker ps | grep {{ project_name }} | cut -d' ' -f1` sbin/nginx 
  
#   - name: Shutdown docker-compose
#     shell:  cd {{ dest_dir }} && docker-compose down && docker container prune && docker image prune
#     ignore_errors: yes
    
#   - name: -----> Start Docker compose
#     shell: cd {{ dest_dir }} && docker-compose up --build && docker-compose run -d egz-mf
#     register: st
